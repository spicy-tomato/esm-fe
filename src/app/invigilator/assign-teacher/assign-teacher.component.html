<ng-container *ngrxLet="headerObservables$ as obs">
  <div
    class="py-3 flex flex-0 justify-between items-center bg-white text-3xl font-bold"
  >
    <h3 id="title">Phân giảng viên coi thi khoa {{ obs.faculty?.name }}</h3>

    <ng-container
      *ngIf="obs.role === 'ExaminationDepartmentHead'; else buttons"
    >
      <tui-select
        [ngModel]="obs.faculty?.id"
        (ngModelChange)="onSelectFaculty($event)"
        [valueContent]="stringify(obs.faculties)"
        [tuiTextfieldLabelOutside]="true"
        tuiTextfieldSize="m"
        class="w-48"
      >
        <ng-template tuiDataList>
          <tui-data-list>
            <button
              tuiOption
              *ngFor="let faculty of obs.faculties"
              [value]="faculty.id"
              role="menuitemradio"
            >
              {{ faculty.name }}
            </button>
          </tui-data-list>
        </ng-template>
      </tui-select>
    </ng-container>

    <ng-template #buttons>
      <div class="buttons">
        <button
          tuiButton
          *ngIf="
            obs.examination?.status === ExaminationStatus.AssignInvigilator
          "
          (click)="autoAssign()"
          [showLoader]="obs.showLoader"
          [class.!hidden]="hideAutoAssign"
          icon="tuiIconAirplayLarge"
        >
          Tự động phân bổ
        </button>

        <button
          tuiButton
          *ngIf="
            obs.examination?.status === ExaminationStatus.AssignInvigilator
          "
          (click)="saveChange()"
          [showLoader]="obs.showLoader"
          [disabled]="!form || form.pristine"
          icon="tuiIconSaveLarge"
        >
          Lưu
        </button>

        <!-- TODO -->
        <!-- <button tuiButton icon="tuiIconDownloadLarge">Tải file Excel</button> -->
      </div>
    </ng-template>
  </div>
</ng-container>

<ng-container *ngrxLet="dataStatus$ as dataStatus">
  <tui-loader
    *ngIf="dataStatus === 'loading'; else loaded"
    class="h-40"
  ></tui-loader>
</ng-container>

<ng-template #loaded>
  <h2 *ngIf="dataError$ | async; else dataTable" class="mt-4 text-base">
    Phòng Khảo thí chưa phân số lượng cho khoa, vui lòng thử lại sau!
  </h2>
</ng-template>

<ng-template #dataTable>
  <tui-scrollbar class="scrollbar" class="flex-1">
    <cdk-virtual-scroll-viewport
      #viewport
      tuiScrollable
      [itemSize]="45"
      [maxBufferPx]="1000"
      [minBufferPx]="700"
      class="h-full tui-zero-scrollbar"
    >
      <table
        tuiTable
        *ngIf="form"
        [formGroup]="form"
        [columns]="columns"
        class="w-full"
        aria-describedby="title"
      >
        <thead tuiThead>
          <tr
            tuiThGroup
            *ngrxLet="0 - viewport['_renderedContentOffset'] as offset"
          >
            <th tuiTh [sticky]="true" [style.top.px]="offset">STT</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Mã học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Tên học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Ngày thi</th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Ca thi
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Bộ môn
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Họ tên CBCT
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              SĐT
            </th>
          </tr>
        </thead>

        <tbody tuiTbody *ngrxLet="tableObservables$ as obs">
          <tr *cdkVirtualFor="let row of obs.data; let i = index" tuiTr>
            <td *tuiCell="'index'" tuiTd class="w-8">{{ i + 1 }}</td>
            <td *tuiCell="'moduleId'" tuiTd class="w-32 max-w-[8rem]">
              {{ row.facultyShiftGroup.shiftGroup.module.displayId }}
            </td>
            <td *tuiCell="'moduleName'" tuiTd>
              {{ row.facultyShiftGroup.shiftGroup.module.name }}
            </td>
            <td *tuiCell="'startAt'" tuiTd class="w-32">
              {{ row.facultyShiftGroup.shiftGroup.startAt | date : "dd/MM/y" }}
            </td>
            <td *tuiCell="'shift'" tuiTd class="w-24 !text-center">
              {{ row.facultyShiftGroup.shiftGroup.shift }}
            </td>

            <ng-container *ngrxLet="form.controls[row.id] as rowControl">
              <td *tuiCell="'department'" tuiTd class="w-60">
                <tui-select
                  *ngIf="obs.role === 'Teacher'; else departmentTmpl"
                  (ngModelChange)="rowControl.controls.user.setValue(null)"
                  [formControl]="rowControl.controls.departmentId"
                  [valueContent]="stringify(obs.departments)"
                  class="w-60"
                >
                  <ng-template tuiDataList>
                    <tui-data-list>
                      <button
                        tuiOption
                        *ngFor="let department of obs.departments"
                        [value]="department.id"
                      >
                        {{ department.name }}
                      </button>
                    </tui-data-list>
                  </ng-template>
                </tui-select>

                <ng-template #departmentTmpl>
                  {{
                    rowControl.value.user
                      ? obs.invigilatorInfoMap[rowControl.value.user.id]
                          ?.department?.name
                      : ""
                  }}
                </ng-template>
              </td>

              <td
                *tuiCell="'teacher'"
                tuiTd
                [class.!bg-tui-warning-bg-hover]="customValues[row.id]"
                class="w-60"
              >
                <tui-combo-box
                  *ngIf="obs.role === 'Teacher'; else teacherTmpl"
                  [(search)]="customValues[row.id]"
                  [formControl]="rowControl.controls.user"
                  [valueContent]="invigilatorContent"
                  [identityMatcher]="invigilatorIdentityMatcher"
                  class="w-60"
                >
                  <ng-template tuiDataList>
                    <tui-data-list>
                      <button
                        *ngFor="
                          let invigilator of obs.invigilatorsData
                            | tuiFilter
                              : invigilatorMatcher
                              : rowControl.value.departmentId
                        "
                        tuiOption
                        [value]="invigilator"
                      >
                        {{ invigilator }}
                      </button>
                    </tui-data-list>
                  </ng-template>
                </tui-combo-box>

                <ng-template #teacherTmpl>
                  {{ rowControl.value.user?.fullName }}
                </ng-template>
              </td>

              <td *tuiCell="'phoneNumber'" tuiTd class="w-32">
                {{
                  rowControl.value.user
                    ? obs.invigilatorInfoMap[rowControl.value.user.id]
                        ?.phoneNumber
                    : ""
                }}
              </td>
            </ng-container>
          </tr>
        </tbody>
      </table>
    </cdk-virtual-scroll-viewport>
  </tui-scrollbar>
</ng-template>

<ng-template #invigilatorContent let-item>
  <span class="name">{{ item.fullName }}</span>
</ng-template>
