<ng-container *ngrxLet="showLoader$ as showLoader">
  <div
    class="py-3 flex flex-0 justify-between items-center bg-white text-3xl font-bold"
  >
    <h3 id="title">Phân công phòng thi</h3>
    <div *ngrxLet="examination$ as examination" class="buttons">
      <button
        tuiButton
        *ngIf="examination?.status === ExaminationStatus.AssignInvigilator"
        (click)="autoAssign()"
        [showLoader]="showLoader"
        icon="tuiIconAirplayLarge"
      >
        Tự động phân bổ
      </button>
      <button
        tuiButton
        *ngIf="examination?.status === ExaminationStatus.AssignInvigilator"
        (click)="saveChange()"
        [showLoader]="showLoader"
        icon="tuiIconSaveLarge"
      >
        Lưu
      </button>
      <!-- TODO -->
      <!-- <button tuiButton icon="tuiIconDownloadLarge">Tải file Excel</button> -->
    </div>
  </div>
</ng-container>

<ng-container *ngrxLet="dataStatus$ as dataStatus">
  <tui-loader
    *ngIf="dataStatus === 'loading'; else loaded"
    class="h-40"
  ></tui-loader>
</ng-container>

<ng-template #loaded>
  <tui-scrollbar class="scrollbar" class="flex-1">
    <cdk-virtual-scroll-viewport
      #viewport
      tuiScrollable
      [itemSize]="45"
      [maxBufferPx]="1000"
      [minBufferPx]="700"
      class="h-full tui-zero-scrollbar"
    >
      <table
        tuiTable
        *ngIf="form"
        [formGroup]="form"
        [columns]="columns"
        class="w-full"
        aria-describedby="title"
      >
        <thead tuiThead>
          <tr
            tuiThGroup
            *ngrxLet="0 - viewport['_renderedContentOffset'] as offset"
          >
            <th tuiTh [sticky]="true" [style.top.px]="offset">STT</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Mã học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Tên học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Ngày thi</th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Ca thi
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Phòng
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Số thí sinh
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              STT CBCT
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Họ tên CBCT
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Khoa
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Bộ môn
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              SĐT
            </th>
          </tr>
        </thead>

        <tbody tuiTbody>
          <ng-container *ngrxLet="tableObservables$ as tableObservables">
            <ng-container
              *ngrxLet="
                invigilatorStringify(
                  tableObservables.invigilatorsList
                ) as invigilatorContent
              "
            >
              <tr
                tuiTr
                *cdkVirtualFor="let row of tableObservables.data; let i = index"
                [class.no-invigilator]="!row.invigilator"
                [class.duplicated]="row.isDuplicated"
              >
                <td *tuiCell="'index'" tuiTd class="w-8">
                  {{ i + 1 }}
                </td>
                <td *tuiCell="'moduleId'" tuiTd class="w-32 max-w-[8rem]">
                  {{ row.shiftGroup.module.displayId }}
                </td>
                <td *tuiCell="'moduleName'" tuiTd>
                  {{ row.shiftGroup.module.name }}
                </td>
                <td *tuiCell="'startAt'" tuiTd class="w-32">
                  {{ row.shiftGroup.startAt | date : "dd/MM/y" }}
                </td>
                <td *tuiCell="'shift'" tuiTd class="w-24 !text-center">
                  {{ row.shiftGroup.shift }}
                </td>
                <td *tuiCell="'room'" tuiTd class="w-24 !text-center">
                  {{ row.room.displayId }}
                </td>
                <td *tuiCell="'candidatesCount'" tuiTd class="w-24 !text-center">
                  {{ row.candidatesCount }}
                </td>
                <td *tuiCell="'orderIndex'" tuiTd class="w-24 !text-center">
                  {{ row.orderIndex }}
                </td>

                <td *tuiCell="'teacher'" tuiTd class="w-64">
                  <tui-select
                    *ngrxLet="
                      invigilatorStringify(
                        tableObservables.invigilatorsList
                      ) as invigilatorContent
                    "
                    (ngModelChange)="
                      onInvigilatorChanges(row.shiftGroup.id, row.id, $event)
                    "
                    [formControl]="form.controls[row.id]"
                    [valueContent]="invigilatorContent"
                    [tuiTextfieldCleaner]="true"
                    class="w-64"
                  >
                    <ng-template tuiDataList>
                      <tui-data-list
                        *ngrxLet="tableObservables$ as tableObservables"
                      >
                        <tui-opt-group>
                          <ng-container
                            *ngFor="
                              let invigilator of tableObservables
                                .invigilatorsData[row.shiftGroup.id]
                            "
                          >
                            <!-- Only show prior invigilators on first row, else show other ones -->
                            <ng-container
                              *ngIf="
                                (row.orderIndex === 1 &&
                                  invigilator.isPriority) ||
                                (row.orderIndex !== 1 &&
                                  !invigilator.isPriority)
                              "
                            >
                              <!-- Show template to add  -->
                              <ng-container
                                *ngIf="
                                  invigilator
                                    | object
                                      : 'in'
                                      : 'temporaryName'
                                      : temporaryInvigilatorModel;
                                  else selection
                                "
                              >
                                <button
                                  tuiOption
                                  (click)="
                                    onAddNewInvigilator(
                                      invigilator.temporaryName,
                                      invigilator.departmentId,
                                      row.shiftGroup.id
                                    )
                                  "
                                  class="relative"
                                >
                                  <div class="custom-btn">
                                    {{ invigilator.temporaryName }}
                                    <tui-svg
                                      src="tuiIconPlusCircleLarge"
                                      class="text-tui-text-link"
                                    ></tui-svg>
                                  </div>
                                </button>
                              </ng-container>

                              <!-- Show selection -->
                              <ng-template #selection>
                                <button
                                  tuiOption
                                  *ngIf="!(tableObservables.usedInvigilatorsMap[row.shiftGroup.id]?.[$any(invigilator).id])"
                                  [value]="$any(invigilator).id"
                                >
                                  {{ $any(invigilator).fullName }}
                                </button>
                              </ng-template>
                            </ng-container>
                          </ng-container>
                        </tui-opt-group>

                        <!-- Add teacher that does not assigned in current shift group -->
                        <tui-opt-group>
                          <button
                            tuiOption
                            (click)="onAddOtherInvigilator(row.id)"
                            class="relative"
                          >
                            <div class="custom-btn">
                              Chọn CBCT khác
                              <tui-svg
                                src="tuiIconPlusCircleLarge"
                                class="text-tui-text-link"
                              ></tui-svg>
                            </div>
                          </button>
                        </tui-opt-group>
                      </tui-data-list>
                    </ng-template>
                  </tui-select>
                </td>

                <td *tuiCell="'teacherFaculty'" tuiTd class="w-40">
                  {{
                    form.controls[row.id].value
                      ? tableObservables.invigilatorFacultyMap[
                          form.controls[row.id].value!
                        ]?.facultyName
                      : ""
                  }}
                </td>

                <td *tuiCell="'teacherDepartment'" tuiTd class="w-48">
                  {{
                    form.controls[row.id].value
                      ? tableObservables.invigilatorFacultyMap[
                          form.controls[row.id].value!
                        ]?.departmentName
                      : ""
                  }}
                </td>

                <td *tuiCell="'phoneNumber'" tuiTd class="w-32">
                  {{
                    form.controls[row.id].value
                      ? tableObservables.invigilatorFacultyMap[
                          form.controls[row.id].value!
                        ]?.phoneNumber
                      : ""
                  }}
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </cdk-virtual-scroll-viewport>
  </tui-scrollbar>
</ng-template>
