<ng-container *ngrxLet="showLoader$ as showLoader">
  <div
    class="py-3 flex flex-0 justify-between items-center bg-white text-3xl font-bold"
  >
    <h3>Phân công phòng thi</h3>
    <div *ngrxLet="examination$ as examination" class="buttons">
      <button
        tuiButton
        *ngIf="examination?.status === ExaminationStatus.AssignInvigilator"
        (click)="autoAssign()"
        [showLoader]="showLoader"
        icon="tuiIconAirplayLarge"
      >
        Tự động phân bổ
      </button>
      <button
        tuiButton
        *ngIf="examination?.status === ExaminationStatus.AssignInvigilator"
        (click)="saveChange()"
        [showLoader]="showLoader"
        icon="tuiIconSaveLarge"
      >
        Lưu
      </button>
      <!-- TODO -->
      <!-- <button tuiButton icon="tuiIconDownloadLarge">Tải file Excel</button> -->
    </div>
  </div>
</ng-container>
<ng-container *ngrxLet="dataStatus$ as dataStatus">
  <tui-loader
    *ngIf="dataStatus === 'loading'; else loaded"
    class="h-40"
  ></tui-loader>
</ng-container>
<ng-template #loaded>
  <tui-scrollbar class="scrollbar" class="flex-1">
    <cdk-virtual-scroll-viewport
      #viewport
      tuiScrollable
      [itemSize]="45"
      [maxBufferPx]="1000"
      [minBufferPx]="700"
      class="h-full tui-zero-scrollbar"
    >
      <table
        tuiTable
        *ngIf="form"
        [formGroup]="form"
        [columns]="columns"
        class="w-full"
      >
        <thead tuiThead>
          <tr
            tuiThGroup
            *esmVar="0 - viewport['_renderedContentOffset'] as offset"
          >
            <th tuiTh [sticky]="true" [style.top.px]="offset">Mã học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Tên học phần</th>
            <th tuiTh [sticky]="true" [style.top.px]="offset">Ngày thi</th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Ca thi
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Phòng
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              STT CBCT
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Họ tên CBCT
            </th>
            <th
              tuiTh
              [sticky]="true"
              [style.top.px]="offset"
              class="!text-center"
            >
              Khoa
            </th>
          </tr>
        </thead>
        <tbody tuiTbody>
          <ng-container *ngrxLet="data$ as data">
            <ng-container *ngrxLet="invigilatorsData$ as invigilatorsData">
              <ng-container *ngrxLet="invigilatorsList$ as invigilatorsList">
                <ng-container
                  *ngIf="usedInvigilatorsMap$ | async as usedInvigilatorsMap"
                >
                  <ng-container
                    *esmVar="
                      invigilatorStringify(
                        invigilatorsList
                      ) as invigilatorContent
                    "
                  >
                    <tr
                      tuiTr
                      *cdkVirtualFor="let row of data"
                      [class.duplicated]="row.isDuplicated"
                    >
                      <td *tuiCell="'moduleId'" tuiTd class="w-32 max-w-[8rem]">
                        {{ row.shiftGroup.module.displayId }}
                      </td>
                      <td *tuiCell="'moduleName'" tuiTd>
                        {{ row.shiftGroup.module.name }}
                      </td>
                      <td *tuiCell="'startAt'" tuiTd class="w-32">
                        {{ row.shiftGroup.startAt | date : "dd/MM/y" }}
                      </td>
                      <td *tuiCell="'shift'" tuiTd class="w-24 !text-center">
                        {{ row.shiftGroup.shift }}
                      </td>
                      <td *tuiCell="'room'" tuiTd class="w-24 !text-center">
                        {{ row.room.displayId }}
                      </td>
                      <td
                        *tuiCell="'orderIndex'"
                        tuiTd
                        class="w-24 !text-center"
                      >
                        {{ row.orderIndex }}
                      </td>

                      <ng-container
                        *esmVar="form.controls[row.id] as rowControl"
                      >
                        <ng-container
                          *esmVar="
                            invigilatorsData[row.shiftGroup.id] as invigilators
                          "
                        >
                          <td *tuiCell="'teacher'" tuiTd class="w-60">
                            <tui-select
                              (ngModelChange)="
                                onInvigilatorChanges(
                                  row.shiftGroup.id,
                                  row.id,
                                  $event
                                )
                              "
                              [formControl]="rowControl"
                              [valueContent]="invigilatorContent"
                              [tuiTextfieldCleaner]="true"
                              class="w-60"
                            >
                              <ng-template tuiDataList>
                                <tui-data-list>
                                  <ng-container
                                    *ngFor="let invigilator of invigilators"
                                  >
                                    <button
                                      tuiOption
                                      *ngIf="
                                        !(usedInvigilatorsMap[row.shiftGroup.id]?.[invigilator.id]) && 
                                          ((row.orderIndex === 1 && invigilator.isPriority) 
                                          || (row.orderIndex !== 1 && !invigilator.isPriority))
                                      "
                                      [value]="invigilator.id"
                                    >
                                      {{ invigilator.fullName }}
                                    </button>
                                  </ng-container>
                                </tui-data-list>
                              </ng-template>
                            </tui-select>
                          </td>
                        </ng-container>
                      </ng-container>

                      <td *tuiCell="'teacherDepartment'" tuiTd class="w-24">
                        {{ row.invigilator?.department?.faculty?.displayId }}
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </tbody>
      </table>
    </cdk-virtual-scroll-viewport>
  </tui-scrollbar>
</ng-template>
